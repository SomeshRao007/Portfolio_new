import fs from 'fs';
import path from 'path';

const STRAPI_URL = process.env.VITE_STRAPI_URL;
const STRAPI_TOKEN = process.env.VITE_STRAPI_TOKEN;

if (!STRAPI_URL || !STRAPI_TOKEN) {
  console.error('‚ùå Missing STRAPI_URL or STRAPI_TOKEN in environment variables');
  process.exit(1);
}

const fetchFromStrapi = async (endpoint, populate = '') => {
  const url = `${STRAPI_URL}/api/${endpoint}${populate ? `?${populate}` : ''}`;
  
  const response = await fetch(url, {
    headers: {
      'Authorization': `Bearer ${STRAPI_TOKEN}`,
    },
  });

  if (!response.ok) {
    throw new Error(`Failed to fetch ${endpoint}: ${response.statusText}`);
  }

  const data = await response.json();
  return data;
};

const transformStrapiImage = (imageData) => {
  if (!imageData?.url) return '';
  return imageData.url.startsWith('http') 
    ? imageData.url 
    : `${STRAPI_URL}${imageData.url}`;
};

const fetchAllData = async () => {
  try {
    console.log('üöÄ Fetching data from Strapi...');

    // Fetch Personal Info
    const personalInfoRes = await fetchFromStrapi(
      'personal-info',
      'populate[profileImage]=*&populate[socialLinks][populate]=icon'
    );
    const personalInfoData = personalInfoRes.data;
    
    const personalInfo = {
      name: personalInfoData.name,
      title: personalInfoData.title,
      bio: personalInfoData.bio,
      profileImageUrl: transformStrapiImage(personalInfoData.profileImage),
      formspreeEndpoint: personalInfoData.formspreeEndpoint,
      cvUrl: personalInfoData.cvUrl || '',
      socialLinks: personalInfoData.socialLinks?.map(link => ({
        name: link.name,
        url: link.url,
        icon: transformStrapiImage(link.icon),
      })) || [],
    };

    // Fetch Skills
    const skillsRes = await fetchFromStrapi(
      'skill-categories',
      'populate[skills][populate]=icon&sort=order:asc'
    );
    const skills = skillsRes.data.map(category => ({
      name: category.name,
      skills: category.skills.map(skill => ({
        name: skill.name,
        icon: transformStrapiImage(skill.icon),
      })),
    }));

    // Fetch Certifications
    const certificationsRes = await fetchFromStrapi(
      'certifications',
      'populate=image&sort=order:asc'
    );
    const certifications = certificationsRes.data.map(cert => ({
      title: cert.title,
      issuer: cert.issuer,
      imageUrl: transformStrapiImage(cert.image),
      link: cert.link,
    }));

    // Fetch Timeline
    const timelineRes = await fetchFromStrapi(
      'timeline-events',
      'sort=date:desc'
    );
    const timeline = timelineRes.data.map(event => ({
      date: event.date,
      title: event.title,
      description: event.description,
      fullDescription: event.fullDescription,
      icon: event.icon,
    }));

    // Fetch Learning Items
    const learningRes = await fetchFromStrapi(
      'learning-items',
      'sort=order:asc'
    );
    const learning = learningRes.data.map(item => ({
      title: item.title,
      description: item.description,
    }));

    // Fetch Stats
    const statsRes = await fetchFromStrapi(
      'stats',
      'sort=order:asc'
    );
    const stats = statsRes.data.map(stat => ({
      label: stat.label,
      value: stat.value,
    }));

    // Fetch Projects
    const projectsRes = await fetchFromStrapi(
      'projects',
      'populate=image&sort=order:asc'
    );
    const projects = projectsRes.data.map(project => ({
      title: project.title,
      description: project.description,
      imageUrl: transformStrapiImage(project.image),
      githubUrl: project.githubUrl || '',
      ...(project.interactiveComponent && { 
        interactiveComponent: project.interactiveComponent 
      }),
    }));

    // Fetch Testimonials
    const testimonialsRes = await fetchFromStrapi(
      'testimonials',
      'sort=order:asc'
    );
    const testimonials = testimonialsRes.data.map(testimonial => ({
      quote: testimonial.quote,
      author: testimonial.author,
      company: testimonial.company,
    }));

    const finalData = {
      personalInfo,
      skills,
      certifications,
      timeline,
      learning,
      stats,
      projects,
      testimonials,
    };

    // Write to file
    const outputPath = path.join(process.cwd(), 'src', 'generated-strapi-data.ts');
    
    const tsContent = `// This file is auto-generated by scripts/fetch-strapi-data.mjs  Do not edit manually - your changes will be overwritten

export const STRAPI_DATA = ${JSON.stringify(finalData, null, 2)} as const;`;
    
    fs.writeFileSync(outputPath, tsContent);
    
    
    console.log('‚úÖ Successfully fetched and saved Strapi data!');
    console.log(`üìÑ Data saved to: ${outputPath}`);
    
  } catch (error) {
    console.error('‚ùå Error fetching Strapi data:', error.message);
    process.exit(1);
  }
};

fetchAllData();